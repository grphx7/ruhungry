<!DOCTYPE html>
<html>
<head>
<title>Food Voting App</title>
<style>
body {
  background-color: #222;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.container {
  background-color: #eee;
  border: 1px solid #ccc;
  padding: 20px;
  border-radius: 5px;
  text-align: center;
}

.passcode {
  margin-bottom: 10px;
}

.option {
  margin-bottom: 5px;
  cursor: pointer;
}

.custom-option {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.remove-button {
  color: red;
  cursor: pointer;
}

</style>
</head>
<body>

<div class="container">
  <div class="passcode">
    Passcode: <span id="current-passcode"></span>
  </div>

  <div id="options-container"></div>

  <div>
    <input type="text" id="custom-option-input" placeholder="Enter custom option">
    <button id="add-custom-option">Add</button>
  </div>

  <button id="submit-button">Submit</button>
</div>

<script>
  const passcodeRegex = /^[a-zA-Z0-9]{5}$/; // Allow alphanumeric characters only
  const defaultOptions = [
    { name: "Mcdonalds", points: 0 },
    { name: "Taco Bell", points: 0 },
    { name: "Sonic", points: 0 },
    { name: "Pizza Hut", points: 0 },
    { name: "Subway", points: 0 }
  ];
  let currentPasscode;
  let userChoices = []; 

  // Function to generate a random 5-character passcode
  function generateRandomPasscode() {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let passcode = '';
    for (let i = 0; i < 5; i++) {
      passcode += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return passcode;
  }

  // Function to load options from file or use defaults
  async function loadOptions() {
    if (currentPasscode) {
      try {
        const response = await fetch(`saves/${currentPasscode}.txt`);
        const data = await response.text();
        const lines = data.split('\n');
        const options = [];
        for (const line of lines) {
          const [name, points] = line.split(':');
          options.push({ name, points: parseInt(points) });
        }
        displayOptions(options);
      } catch (error) {
        console.error("Error loading options:", error);
        displayOptions(defaultOptions);
      }
    } else {
      displayOptions(defaultOptions);
    }
  }

  // Function to display options on the page
  function displayOptions(options) {
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = ''; 

    options.forEach((option, index) => {
      const optionElement = document.createElement('div');
      optionElement.classList.add('option');
      optionElement.textContent = `${option.name} (${option.points})`;
      optionElement.addEventListener('click', () => {
        handleOptionClick(option, index);
      });
      optionsContainer.appendChild(optionElement);
    });
  }

  // Function to handle option clicks
  function handleOptionClick(option, index) {
    const optionElements = document.querySelectorAll('.option');

    if (userChoices.includes(index)) { 
      // Remove vote
      userChoices = userChoices.filter(i => i !== index);
      optionElements[index].textContent = `${option.name} (${option.points})`; 
      return;
    }

    if (userChoices.length < 3) { 
      // Add vote
      userChoices.push(index);
      optionElements[index].textContent = `${option.name} (${option.points}) ${userChoices.length}`; 
    } else { 
      // Replace last vote
      userChoices[2] = index;
      optionElements[userChoices[0]].textContent = `${options[userChoices[0]].name} (${options[userChoices[0]].points}) 1`;
      optionElements[userChoices[1]].textContent = `${options[userChoices[1]].name} (${options[userChoices[1]].points}) 2`;
      optionElements[index].textContent = `${option.name} (${option.points}) 3`;
    }
  }

  // Function to add custom option
  function addCustomOption() {
    const input = document.getElementById('custom-option-input');
    const customOption = input.value.trim();

    if (customOption) {
      const newOptions = [...defaultOptions, { name: customOption, points: 0 }]; 
      displayOptions(newOptions);
      input.value = '';
    }
  }

  // Function to remove custom option
  function removeCustomOption(index) {
    const options = [...defaultOptions]; 
    options.splice(index - defaultOptions.length, 1); 
    displayOptions(options);
  }

  // Function to submit votes and save to file
  async function submitVotes() {
    const options = [...defaultOptions]; 
    const customOptionInput = document.getElementById('custom-option-input');
    const customOption = customOptionInput.value.trim();
    if (customOption) {
      options.push({ name: customOption, points: 0 }); 
    }

    options[userChoices[0]].points += 4;
    options[userChoices[1]].points += 2;
    options[userChoices[2]].points += 1;

    try {
      const file = new File([options.map(option => `${option.name}:${option.points}`).join('\n')], `${currentPasscode}.txt`, { type: 'text/plain' });
      await fetch(`saves/${currentPasscode}.txt`, {
        method: 'PUT',
        body: file
      });
      alert('Votes submitted successfully!');
    } catch (error) {
      console.error("Error saving votes:", error);
      alert('Error saving votes. Please try again.');
    }
  }

  // Initialize
  const passcodeInput = document.getElementById('passcode-input');
  const submitButton = document.getElementById('submit-button');
  const addCustomOptionButton = document.getElementById('add-custom-option');

  // Handle passcode input
  // passcodeInput.addEventListener('input', () => {
  //   const enteredPasscode = passcodeInput.value;
  //   if (passcodeRegex.test(enteredPasscode)) {
  //     currentPasscode = enteredPasscode;
  //     loadOptions();
  //   } else {
  //     currentPasscode = null;
  //     // Display error message or clear options
  //   }
  // });

  // Generate and use initial passcode
  do {
    currentPasscode = generateRandomPasscode();
  } while (await fileExists(`saves/${currentPasscode}.txt`));

  document.getElementById('current-passcode').textContent = currentPasscode; 
  loadOptions();

  // Handle custom option input
  addCustomOptionButton.addEventListener('click', addCustomOption);

  // Handle submit button click
  submitButton.addEventListener('click', submitVotes);

  // Helper function to check if file exists
  async function fileExists(filePath) {
    try {
      const response = await fetch(filePath);
      return response.ok;
    } catch (error) {
      return false;
    }
  }
</script>

</body>
</html>
